<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Todo</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif}
.app{max-width:480px;margin:auto;padding:16px;background:#121212}
h2{font-size:18px;margin:16px 0 8px}
.week{display:flex;gap:4px;margin-bottom:6px}
.day{flex:1;background:#1e1e1e;padding:6px 0;border-radius:10px;text-align:center;font-size:12px;cursor:pointer}
.day.done{background:#1e88e5}
.card{background:#1e1e1e;border-radius:16px;padding:14px;margin-top:6px}
input{flex:1;padding:12px;border:none;border-radius:10px;background:#2a2a2a;color:#fff}
button{background:#1877f2;border:none;color:white;border-radius:10px;padding:12px}
ul{list-style:none;padding:0;margin:0}
li{background:#2a2a2a;margin-bottom:8px;padding:10px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.checkBox{width:20px;height:20px;border:2px solid #555;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:bold}
.checked{border-color:#4caf50;background:#123f1a;color:#4caf50}
.actions{display:flex;align-items:center;gap:6px}
.del-btn{background:transparent;color:red;font-size:16px;border:none}

/* 통계 그래프 */
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.stat-item{text-align:center;font-size:11px}
.bar-box{height:80px;display:flex;align-items:flex-end;justify-content:center;background:#1e1e1e;border-radius:8px;padding:4px}
.bar{width:20px;background:#4caf50;border-radius:4px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:999}
.modalBox{background:#1e1e1e;padding:20px;border-radius:16px;width:80%}
</style>
</head>

<body>
<div class="app">

<h2>지난 주 한 일</h2>
<div class="week" id="lastWeekBar"></div>

<h2>이번 주 한 일</h2>
<div class="week" id="thisWeekBar"></div>

<h2>일일 할 일</h2>
<div class="card">
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <input id="todoInput" placeholder="할 일 입력">
    <button id="addBtn">+</button>
  </div>
  <ul id="todoList"></ul>
</div>

<h2>지난 주 통계</h2>
<div id="statsArea"></div>

</div>

<div class="modal" id="modal">
 <div class="modalBox">
   <h3 id="modalTitle"></h3>
   <ul id="modalList"></ul>
   <button onclick="closeModal()">닫기</button>
 </div>
</div>

<script>
const days=["월","화","수","목","금","토","일"];

const listEl=document.getElementById("todoList");
const inputEl=document.getElementById("todoInput");
const lastWeekBar=document.getElementById("lastWeekBar");
const thisWeekBar=document.getElementById("thisWeekBar");
const statsArea=document.getElementById("statsArea");

let todos=JSON.parse(localStorage.getItem("todos")||"[]");
let history=JSON.parse(localStorage.getItem("history")||"{}");
let lastHistory=JSON.parse(localStorage.getItem("lastHistory")||"{}");
let dayTasks=JSON.parse(localStorage.getItem("dayTasks")||"{}");

let lastDailyReset=localStorage.getItem("lastDailyReset");
let lastWeeklyReset=localStorage.getItem("lastWeeklyReset");

function nowKST(){
 return new Date(Date.now() + 9*60*60*1000);
}

function todayKey(){
 const d=nowKST();
 if(d.getHours()<5)d.setDate(d.getDate()-1);
 return d.toISOString().split("T")[0];
}

function isMonday(){
 const d=nowKST();
 if(d.getHours()<5)d.setDate(d.getDate()-1);
 return d.getDay()===1;
}

function checkResets(){
 const today=todayKey();
 if(lastDailyReset!==today){
   todos=todos.map(t=>({...t,done:false}));
   lastDailyReset=today;
 }
 if(isMonday()&&lastWeeklyReset!==today){
   lastHistory={...history};
   history={};
   lastWeeklyReset=today;
 }
 saveAll();
}

function saveAll(){
 localStorage.setItem("todos",JSON.stringify(todos));
 localStorage.setItem("history",JSON.stringify(history));
 localStorage.setItem("lastHistory",JSON.stringify(lastHistory));
 localStorage.setItem("dayTasks",JSON.stringify(dayTasks));
 localStorage.setItem("lastDailyReset",lastDailyReset);
 localStorage.setItem("lastWeeklyReset",lastWeeklyReset);
}

function getMonday(offset=0){
 const d=nowKST();
 const day=d.getDay();
 const diff=(day===0?-6:1)-day;
 d.setDate(d.getDate()+diff+(offset*7));
 return d;
}

function updateHistory(){
 const key=todayKey();
 history[key]={done:todos.filter(t=>t.done).length,total:todos.length};
 dayTasks[key]=todos.map(t=>({...t}));
 saveAll();
}

function renderWeek(bar,dataStore,offset){
 bar.innerHTML="";
 const m=getMonday(offset);
 for(let i=0;i<7;i++){
  const d=new Date(m);d.setDate(m.getDate()+i);
  const key=d.toISOString().split("T")[0];
  const data=dataStore[key]||{done:0,total:0};

  const div=document.createElement("div");
  div.className="day";
  div.innerHTML=`${days[i]}<br>${data.done}/${data.total}`;
  if(data.done===data.total&&data.total>0)div.classList.add("done");
  bar.appendChild(div);
 }
}

function renderTodos(){
 listEl.innerHTML="";
 todos.forEach((t,i)=>{
  const li=document.createElement("li");
  const txt=document.createElement("span");txt.textContent=t.text;
  const actions=document.createElement("div");actions.className="actions";
  const box=document.createElement("div");box.className="checkBox";
  if(t.done){box.classList.add("checked");box.textContent="✓";}
  const bar=document.createElement("span");bar.textContent="|";
  const del=document.createElement("button");del.className="del-btn";del.textContent="X";

  li.onclick=()=>{todos[i].done=!todos[i].done;updateHistory();render();}
  del.onclick=(e)=>{e.stopPropagation();if(!confirm("삭제?"))return;todos.splice(i,1);updateHistory();render();}

  actions.append(box,bar,del);
  li.append(txt,actions);
  listEl.appendChild(li);
 });
}

function addTodo(){
 const t=inputEl.value.trim();if(!t)return;
 todos.push({text:t,done:false});
 inputEl.value="";updateHistory();render();
}
document.getElementById("addBtn").onclick=addTodo;

function renderStats(){
 statsArea.innerHTML="";
 const countMap={};

 Object.values(dayTasks).forEach(list=>{
  list.forEach(t=>{
   if(t.done){
    countMap[t.text]=(countMap[t.text]||0)+1;
   }
  });
 });

 const entries=Object.entries(countMap);
 const max=Math.max(...entries.map(e=>e[1]),1);

 let row;
 entries.forEach((e,i)=>{
  if(i%4===0){
    row=document.createElement("div");
    row.className="stat-row";
    statsArea.appendChild(row);
  }
  const box=document.createElement("div");
  box.className="stat-item";

  const barBox=document.createElement("div");
  barBox.className="bar-box";

  const bar=document.createElement("div");
  bar.className="bar";
  bar.style.height=(e[1]/max*100)+"%";

  barBox.appendChild(bar);
  box.innerHTML=`${e[0]}<br>${e[1]}회`;
  box.appendChild(barBox);
  row.appendChild(box);
 });
}

function render(){
 renderWeek(lastWeekBar,lastHistory,-1);
 renderWeek(thisWeekBar,history,0);
 renderTodos();
 renderStats();
}

checkResets();
updateHistory();
render();
</script>
</body>
</html>
